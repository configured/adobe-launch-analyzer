# Adobe Launch Rules Dashboard

A Next.js dashboard for visualizing and analyzing Adobe Launch rules, data elements, and extensions extracted using the Adobe DTM extractor tool.

## Features

- **URL Analysis**: Enter an Adobe Launch URL to extract and analyze rules directly
- **AI Script Analysis**: Automatically analyze external action scripts using OpenAI with beautifully formatted markdown output
- **MongoDB Caching**: Optional MongoDB integration to cache AI analysis results for faster responses and reduced API costs
- **File Upload**: Upload JSON files generated by the Adobe DTM extractor
- **Overview Statistics**: Quick summary of rules, data elements, and extensions count
- **Tabbed Interface**: Organized view of rules, data elements, and extensions
- **Search & Filter**: Real-time search across all data types
- **Event Timeline Visualization**: Interactive visual guide with two views and bi-directional navigation:
  - Timeline View: Shows the Adobe Launch event lifecycle from script load through runtime events
  - Rules by Event View: Horizontal list displaying which rules fire on each event type
  - Click rules in timeline to jump to full details; click "View in Timeline" to return
- **Event Type Filtering**: Filter rules by event type (Window Loaded, Click, Direct Call, etc.) with rule counts
- **Event Type Badges**: Visual badges showing event types on each rule for quick identification
- **Evaluation Cost Analysis**:
  - Total complexity score for each rule showing evaluation cost
  - Individual complexity scores for each event, condition, and action module
  - Color-coded indicators (green: low, yellow: medium, red: high complexity)
  - Detailed module settings visualization with arrays and nested objects
- **Enhanced Module Display**:
  - Type-based color coding (blue: events, purple: conditions, orange: actions)
  - Module path and name extraction for easy identification
  - Structured settings display with proper formatting for arrays and objects
  - Special indicators for negated conditions, timeouts, and delays
- **Script Size Analysis**: Display actual file size, gzipped size, and compression ratio for external scripts
- **Expandable Details**: Click to expand and view detailed information for each item
- **Custom Code Display**: Syntax-highlighted display of custom JavaScript code
- **Responsive Design**: Works on desktop and mobile devices

## Getting Started

### Prerequisites

- Node.js 18+ installed
- A JSON file generated by the Adobe DTM extractor (optional)
- OpenAI API key (optional, for script analysis feature)
- MongoDB (optional, for caching AI analysis results)

### Installation

1. Install dependencies:
```bash
npm install
```

2. (Optional) Set up OpenAI API key for script analysis:

   Create a `.env.local` file in the dashboard directory:
   ```bash
   echo "OPENAI_API_KEY=your-openai-api-key-here" > .env.local
   ```

   Get your API key from: https://platform.openai.com/api-keys

   Note: Script analysis feature will be disabled if no API key is provided.

3. (Optional) Set up MongoDB for caching AI analysis results:

   **Why MongoDB?** Caching analysis results in MongoDB provides:
   - Faster analysis responses (instant for cached scripts)
   - Reduced OpenAI API costs (no re-analysis of same scripts)
   - Analysis persistence across server restarts

   **Option A: Local MongoDB**

   Install MongoDB locally (macOS with Homebrew):
   ```bash
   brew install mongodb-community
   brew services start mongodb-community
   ```

   Add to `.env.local`:
   ```bash
   MONGODB_URI=mongodb://localhost:27017
   ```

   **Option B: MongoDB Atlas (Cloud)**

   1. Create free account at https://www.mongodb.com/cloud/atlas
   2. Create a cluster (free tier available)
   3. Get your connection string
   4. Add to `.env.local`:
   ```bash
   MONGODB_URI=mongodb+srv://<username>:<password>@cluster.mongodb.net/adobe-launch-dashboard
   ```

   Note: Dashboard works without MongoDB, but will call OpenAI API for every analysis.

4. Start the development server:
```bash
npm run dev
```

5. Open your browser and navigate to:
```
http://localhost:3000
```

(If port 3000 is in use, Next.js will automatically use the next available port, e.g., 3001)

### Building for Production

```bash
npm run build
npm start
```

## Usage

### Method 1: Analyze URL Directly (Recommended)

1. **Enter Adobe Launch URL**:
   - Paste an Adobe Launch library URL (e.g., `https://assets.adobedtm.com/xxx/xxx/launch-xxx.min.js`)
   - Click the "Extract" button or press Enter
   - The dashboard will fetch and analyze the script in real-time
   - Results will be displayed automatically

### Method 2: Upload JSON File

1. **Upload Data**:
   - Switch to the "Upload File" tab
   - Click the file input and select a JSON file
   - The dashboard will automatically load and display the data

2. **Event Timeline**:
   - At the top of the Rules tab, you'll see an interactive event timeline visualization with two views:

   **Timeline View**:
   - Shows the complete Adobe Launch event lifecycle in vertical timeline format:
     - **Page Load Events** (1-5): libraryLoaded → pageTop → pageBottom → domReady → windowLoaded
     - **Runtime Events** (6-9): directCall, customEvent, user-driven events, runtime-driven events
   - Color-coded cards with numbered sequence
   - Helps understand when different rules will fire during page lifecycle

   **Rules by Event View**:
   - Organized into two horizontal scrollable rows:
     - **Page Load Events** (1-5): libraryLoaded, pageTop, pageBottom, domReady, windowLoaded
     - **Runtime Events** (6+): directCall, customEvent, click, and other events
   - Each event card displays:
     - Event number, name, and description (matching timeline)
     - Count of rules that use this event
     - **Clickable rule links**: Click any rule to jump directly to its full details in the accordion below
     - Color-coded borders matching the timeline colors
   - Only shows events that have rules (automatic filtering)
   - Supports all standard Adobe Launch events plus any custom events found in your data
   - **Navigation**: Click rules to jump to details; use "View in Timeline" link in rule details to return

3. **View Rules**:
   - Navigate to the "Rules" tab
   - Each rule displays:
     - Rule name and ID
     - Event type badges for quick identification
     - Count summary (events, conditions, actions)
     - **Total Cost**: Combined complexity score showing evaluation expense
   - Click on any rule to expand and view detailed modules in a two-row layout:
     - **Row 1**: Events (left column) and Conditions (right column) displayed side-by-side
     - **Row 2**: Actions displayed in full width below
     - **Events** (blue badges): What triggers the rule
     - **Conditions** (purple badges): What must be met for actions to execute
     - **Actions** (orange badges): What executes when conditions pass
   - Each module shows:
     - Module name and path
     - **Complexity score** with color coding:
       - Green (0-4): Simple, low cost
       - Yellow (5-14): Moderate complexity
       - Red (15+): High complexity, performance impact
     - Detailed settings with proper formatting for:
       - Arrays (with item count)
       - Nested objects (JSON formatted)
       - String values
     - Special indicators:
       - ⚠ NEGATED for inverted conditions
       - Timeout values for actions
       - Delay values for events

3. **View Data Elements**:
   - Navigate to the "Data Elements" tab
   - Click on any data element to view its configuration
   - See custom code, default values, and other settings

4. **View Extensions**:
   - Navigate to the "Extensions" tab
   - Click on any extension to view its configuration
   - See extension settings and custom code

5. **Search**:
   - Use the search bar to filter results across all tabs
   - Search by name, ID, or any text within the data

6. **Filter by Event Type**:
   - Use the "Filter by Event Type" dropdown to view only rules triggered by specific events
   - Dropdown shows event types with rule counts (e.g., "Window Loaded (5)")
   - Event type badges appear on each rule for quick visual identification
   - Click "Clear Filter" to reset and show all rules
   - Common event types include:
     - Window Loaded
     - DOM Ready
     - Click
     - Direct Call
     - Custom Event
     - Page Bottom
     - And more...

7. **Analyze External Scripts** (requires OpenAI API key):
   - When viewing actions with external JavaScript files, click "Analyze Script"
   - The dashboard will download the script and use AI to explain:
     - What the script does
     - What data it collects
     - What third-party services it uses
     - Privacy considerations
   - Analysis appears below the script URL
   - Click "View Source Code" to see the full downloaded script with:
     - **File Size Display**: Shows actual size, gzipped size, and compression percentage
     - Automatic extraction of code from `_satellite.__registerScript`
     - Professional syntax highlighting with line numbers
     - Automatic beautification of minified code
     - Toggle between "Beautified" and "Original (Minified)" versions

8. **Analyze New URL**:
   - Click "Analyze New URL" to start a new analysis

## Project Structure

```
dashboard/
├── app/
│   ├── api/
│   │   ├── extract/
│   │   │   └── route.ts     # API endpoint for URL extraction
│   │   └── analyze-script/
│   │       └── route.ts     # API endpoint for AI script analysis
│   ├── layout.tsx           # Root layout
│   ├── page.tsx             # Main dashboard page
│   └── globals.css          # Global styles
├── components/
│   └── ui/                  # shadcn/ui components
│       ├── accordion.tsx
│       ├── button.tsx
│       ├── card.tsx
│       ├── input.tsx
│       ├── select.tsx
│       └── tabs.tsx
├── lib/
│   ├── mongodb.ts           # MongoDB connection utility
│   ├── models/
│   │   └── scriptAnalysis.ts # Script analysis data model
│   └── utils.ts             # Utility functions
├── public/                  # Static assets
├── .env.local               # Environment variables (not in git)
├── .gitignore               # Git ignore file
├── package.json
├── tailwind.config.ts       # Tailwind configuration
├── tsconfig.json            # TypeScript configuration
└── next.config.mjs          # Next.js configuration
```

## Technologies Used

- **Next.js 14**: React framework with App Router
- **TypeScript**: Type-safe development
- **Tailwind CSS**: Utility-first CSS framework
- **shadcn/ui**: Component library built on Radix UI
- **Radix UI**: Accessible component primitives
- **lucide-react**: Icon library
- **Axios**: HTTP client for API requests
- **OpenAI**: AI-powered script analysis
- **MongoDB**: Database for caching AI analysis results (optional)
- **React Markdown**: Markdown rendering for AI analysis with GitHub Flavored Markdown support

## Data Format

The dashboard expects JSON files in the following format:

```json
{
  "metadata": {
    "extractedAt": "2025-12-07T...",
    "sourceUrl": "https://...",
    "ruleCount": 145,
    "dataElementCount": 111,
    "extensionCount": 10
  },
  "rules": [...],
  "dataElements": {...},
  "extensions": {...},
  "buildInfo": {...}
}
```

This format is automatically generated by the Adobe DTM extractor tool in JSON output mode.

## How It Works

### URL Analysis (Built-in Extraction)

When you enter an Adobe Launch URL:

1. The dashboard sends the URL to the `/api/extract` endpoint
2. The API fetches the Adobe Launch script via HTTP
3. The script is executed in a secure VM sandbox to extract the `_satellite._container` object
4. All rules, data elements, and extensions are extracted and serialized
5. Custom JavaScript functions are preserved as source code strings
6. Results are returned and displayed in real-time

### Alternative: Command-Line Extraction

You can also use the standalone extractor tool:

1. Navigate to the extractor directory (parent directory):
```bash
cd ..
```

2. Run the extractor:
```bash
node src/index.js <adobe-launch-url> -f json
```

3. Find the generated JSON file in the `output/` directory

4. Upload this file to the dashboard

## License

MIT
